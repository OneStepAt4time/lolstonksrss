#!/bin/sh
# Pre-push hook for LoL Stonks RSS
# Runs full test suite before allowing push

set -e

echo "Running pre-push checks..."

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

print_error() {
    echo "${RED}[ERROR]${NC} $1"
}

print_success() {
    echo "${GREEN}[SUCCESS]${NC} $1"
}

print_info() {
    echo "${YELLOW}[INFO]${NC} $1"
}

# Get current branch
CURRENT_BRANCH=$(git symbolic-ref --short HEAD)
print_info "Current branch: $CURRENT_BRANCH"

# Prevent pushing directly to main/master
if [ "$CURRENT_BRANCH" = "main" ] || [ "$CURRENT_BRANCH" = "master" ]; then
    print_error "Direct push to $CURRENT_BRANCH is not allowed"
    print_info "Please create a pull request instead"
    print_info "If you need to push to $CURRENT_BRANCH, use: git push --no-verify"
    exit 1
fi

# Check UV is available
if ! command -v uv > /dev/null 2>&1; then
    print_error "UV is not installed. Install from: https://docs.astral.sh/uv/"
    exit 1
fi

# 1. Run all linting checks
print_info "Running Black formatting check..."
if ! uv run black --check --line-length 100 src/ tests/; then
    print_error "Black formatting check failed"
    print_info "Run: black --line-length 100 src/ tests/"
    exit 1
fi
print_success "Black formatting check passed"

print_info "Running Ruff linting..."
if ! uv run ruff check src/ tests/; then
    print_error "Ruff linting failed"
    print_info "Run: ruff check --fix src/ tests/"
    exit 1
fi
print_success "Ruff linting passed"

print_info "Running mypy type checking..."
if ! uv run mypy src/; then
    print_error "Mypy type checking failed"
    exit 1
fi
print_success "Mypy type checking passed"

# 2. Run test suite (excluding tests that require external server)
# Note: E2E tests requiring running server (test_http_endpoints, test_rss_compliance, test_scheduler_api)
# are run in CI/CD with server infrastructure. Pre-push runs unit/integration tests only.
print_info "Running test suite (unit + integration + offline E2E)..."
if ! uv run pytest -v --cov=src --cov-report=term --cov-report=html \
    --ignore=tests/e2e/test_http_endpoints.py \
    --ignore=tests/e2e/test_rss_compliance.py \
    --ignore=tests/e2e/test_scheduler_api.py; then
    print_error "Tests failed"
    exit 1
fi
print_success "All tests passed"

# 3. Check test coverage
print_info "Checking test coverage..."
COVERAGE=$(uv run pytest --cov=src --cov-report=term \
    --ignore=tests/e2e/test_http_endpoints.py \
    --ignore=tests/e2e/test_rss_compliance.py \
    --ignore=tests/e2e/test_scheduler_api.py | grep "TOTAL" | awk '{print $4}' | sed 's/%//')
if [ -n "$COVERAGE" ]; then
    COVERAGE_INT=${COVERAGE%.*}
    if [ "$COVERAGE_INT" -lt 90 ]; then
        print_error "Test coverage is below 90% (current: ${COVERAGE}%)"
        print_info "Please add more tests to improve coverage"
        exit 1
    fi
    print_success "Test coverage is adequate (${COVERAGE}%)"
fi

# 4. Check for uncommitted changes
if ! git diff-index --quiet HEAD --; then
    print_error "You have uncommitted changes"
    print_info "Please commit or stash your changes before pushing"
    exit 1
fi

# All checks passed
print_success "All pre-push checks passed!"
echo ""
print_info "Pushing to remote..."

exit 0
