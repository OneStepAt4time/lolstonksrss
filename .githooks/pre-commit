#!/bin/sh
# Pre-commit hook for LoL Stonks RSS
# Runs linters and tests before allowing commit

set -e

echo "Running pre-commit checks..."

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Function to print colored messages
print_error() {
    echo "${RED}[ERROR]${NC} $1"
}

print_success() {
    echo "${GREEN}[SUCCESS]${NC} $1"
}

print_info() {
    echo "${YELLOW}[INFO]${NC} $1"
}

# Check if running in a git repository
if ! git rev-parse --git-dir > /dev/null 2>&1; then
    print_error "Not in a git repository"
    exit 1
fi

# Check for staged Python files
STAGED_PYTHON_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep "\.py$" || true)

if [ -z "$STAGED_PYTHON_FILES" ]; then
    print_info "No Python files staged, skipping Python checks"
    exit 0
fi

print_info "Found staged Python files: $(echo $STAGED_PYTHON_FILES | wc -l) files"

# 1. Check code formatting with Black
print_info "Checking code formatting with Black..."
if command -v uv > /dev/null 2>&1; then
    if ! uv run black --check --line-length 100 $STAGED_PYTHON_FILES; then
        print_error "Black formatting check failed"
        print_info "Run: black --line-length 100 $STAGED_PYTHON_FILES"
        exit 1
    fi
    print_success "Black formatting check passed"
else
    print_error "UV is not installed. Install from: https://docs.astral.sh/uv/"
    exit 1
fi

# 2. Lint code with Ruff
print_info "Linting code with Ruff..."
if command -v uv > /dev/null 2>&1; then
    if ! uv run ruff check $STAGED_PYTHON_FILES; then
        print_error "Ruff linting failed"
        print_info "Run: ruff check --fix $STAGED_PYTHON_FILES"
        exit 1
    fi
    print_success "Ruff linting passed"
else
    print_error "UV is not installed. Install from: https://docs.astral.sh/uv/"
    exit 1
fi

# 3. Type check with mypy (only on src files)
STAGED_SRC_FILES=$(echo "$STAGED_PYTHON_FILES" | grep "^src/" || true)
if [ -n "$STAGED_SRC_FILES" ]; then
    print_info "Type checking with mypy..."
    if command -v uv > /dev/null 2>&1; then
        if ! uv run mypy $STAGED_SRC_FILES; then
            print_error "Mypy type checking failed"
            exit 1
        fi
        print_success "Mypy type checking passed"
    else
        print_error "UV is not installed. Install from: https://docs.astral.sh/uv/"
        exit 1
    fi
fi

# 4. Run quick tests (unit tests only)
print_info "Running unit tests..."
if command -v uv > /dev/null 2>&1; then
    if ! uv run pytest tests/unit/ -v --tb=short; then
        print_error "Unit tests failed"
        exit 1
    fi
    print_success "Unit tests passed"
else
    print_error "UV is not installed. Install from: https://docs.astral.sh/uv/"
    exit 1
fi

# 5. Check for common issues
print_info "Checking for common issues..."

# Check for print statements (should use logging)
if grep -n "print(" $STAGED_PYTHON_FILES > /dev/null 2>&1; then
    print_error "Found print() statements. Use logging instead:"
    grep -n "print(" $STAGED_PYTHON_FILES
    print_info "This is a warning, not blocking the commit"
fi

# Check for TODO/FIXME without issue references
if grep -n "TODO\|FIXME" $STAGED_PYTHON_FILES | grep -v "#[0-9]" > /dev/null 2>&1; then
    print_error "Found TODO/FIXME without issue reference:"
    grep -n "TODO\|FIXME" $STAGED_PYTHON_FILES | grep -v "#[0-9]"
    print_info "Consider adding issue numbers to TODO/FIXME comments"
fi

# Check for debugging code
if grep -n "import pdb\|breakpoint()\|import ipdb" $STAGED_PYTHON_FILES > /dev/null 2>&1; then
    print_error "Found debugging code:"
    grep -n "import pdb\|breakpoint()\|import ipdb" $STAGED_PYTHON_FILES
    print_error "Remove debugging code before committing"
    exit 1
fi

# All checks passed
print_success "All pre-commit checks passed!"
echo ""
print_info "You can now commit your changes"

exit 0
